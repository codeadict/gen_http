%% -*- mode: erlang; -*-
{minimum_otp_vsn, "25"}.

{erl_opts, [
    debug_info,
    report_warnings,
    {warn_format, 1},
    warn_export_vars,
    warn_unused_vars,
    warn_obsolete_guard,
    warn_unused_import,
    warn_missing_spec,
    warn_untyped_record
]}.

{project_plugins, [
    {rebar3_lint, "3.2.6"},
    {erlfmt, "1.5.0"},
    rebar3_proper
]}.

{erlfmt, [
    write,
    {print_width, 120},
    {files, [
        "{src,include,test}/*.{hrl,erl}",
        "src/*.app.src",
        "rebar.config",
        "elvis.config"
    ]}
]}.

{dialyzer, [
    {warnings, [
        unmatched_returns,
        error_handling,
        unknown
    ]},
    {plt_apps, all_deps}
]}.

{xref_checks, [
    undefined_function_calls,
    undefined_functions,
    exports_not_used,
    locals_not_used,
    deprecated_function_calls,
    deprecated_functions
]}.

%% Suppress xref warnings for public library API functions
%% These are intentionally exported for external use
{xref_ignores, [
    %% Public library API - Main interface
    {gen_http, connect, 3},
    {gen_http, connect, 4},
    {gen_http, close, 1},
    {gen_http, is_open, 1},
    {gen_http, is_alive, 1},
    {gen_http, get_socket, 1},
    {gen_http, set_mode, 2},
    {gen_http, controlling_process, 2},
    {gen_http, put_log, 2},
    {gen_http, request, 5},
    {gen_http, stream, 2},
    {gen_http, recv, 3},
    {gen_http, put_private, 3},
    {gen_http, get_private, 2},
    {gen_http, get_private, 3},
    {gen_http, delete_private, 2},
    {gen_http, is_retriable_error, 1},
    {gen_http, classify_error, 1},

    %% Protocol-specific APIs (also available for direct use)
    {gen_http_h1, connect, 3},
    {gen_http_h1, get_private, 2},
    {gen_http_h1, stream_request_body, 3},
    {gen_http_h2, connect, 3},
    {gen_http_h2, get_private, 2},
    {gen_http_h2, get_window_size, 2},
    {gen_http_h2, stream_request_body, 3},

    %% Parser utilities (used internally, false positive from xref)
    {gen_http_parser_h2, decode_next, 2},
    {gen_http_parser_h2, encode_raw, 4},
    {gen_http_parser_h2, set_flags, 2},

    %% HPACK utilities (now actively used for SETTINGS_HEADER_TABLE_SIZE)
    {gen_http_parser_hpack, new, 1},
    {gen_http_parser_hpack, set_max_table_size, 2}
]}.

{cover_enabled, true}.
{cover_opts, [verbose]}.

{alias, [
    {test, [
        eunit, ct, proper, {cover, "-v"}
    ]}
]}.

{ct_opts, [
    {sys_config, []},
    {logdir, "_build/test/logs"},
    %% Exclude h2_compliance_SUITE by default (slow, requires special Docker setup)
    %% Run it explicitly with: rebar3 ct --suite=h2_compliance_SUITE
    {suite, [
        error_path_SUITE,
        features_SUITE,
        http1_SUITE,
        http2_SUITE,
        ssl_SUITE,
        unified_SUITE
    ]}
]}.

{deps, []}.

{profiles, [
    {test, [
        {erl_opts, [
            nowarn_untyped_record,
            nowarn_missing_spec
        ]},
        {deps, [{proper, "1.5.0"}]}
    ]},
    {bench, [
        {deps, [
            {erlperf, "2.3.0"}
        ]}
    ]}
]}.
